<div class="" style="padding: 20px !important;">
  <div class="row" style="position: sticky; top: 0; background: white; z-index: 100; padding: 15px 20px; margin: -20px -20px 20px -20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-bottom: 2px solid #6200EA;">
    <div class="col-md-6">
      <h2 style="margin: 0;">{{ tallerForm.idTaller > 0 ? tallerForm.idSale : title }}</h2>
    </div>
    <div class="col-md-6" style="text-align: right; display: flex; align-items: center; justify-content: flex-end;">
      <div style="background: #6200EA; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; margin-right: 10px;">
        Total Taller: {{ totalTaller | currency }}
      </div>

      <button mat-icon-button
              (click)="fn_cancel()"
              style="margin: 0;">
          <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>


    <div class="row">
        <div class="col-md-12">
            <!-- Vendedor -->
            <div class="row">
                <div class="col-md-6">
                    <mat-label>Vendedor: </mat-label>
                    <mat-form-field class="with100">
                        <input #cbxSellerCBX
                        type="text"
                                placeholder="Selecciona..."
                                aria-label="Number"
                                matInput
                                [(ngModel)]="tallerForm.sellerDesc"
                                [matAutocomplete]="cbxSeller"
                                (keyup)="comboBoxKeyUp('cbxSellerCBX', cbxSellerCBX.value, $event)"
                                (click)="cbxSellers_Clear()">
                                <button *ngIf="tallerForm.sellerDesc" matSuffix mat-icon-button aria-label="Clear" (click)="cbxSellers_Clear()">
                                    <mat-icon>close</mat-icon>
                                </button>
                        <mat-autocomplete autoActiveFirstOption
                                            #cbxSeller="matAutocomplete"
                                            (optionSelected)="cbxSellers_SelectedOption( $event )">
                            <mat-option *ngFor="let item of cbxSellers" [value]="item">
                                {{ item.name }}
                            </mat-option>

                            <mat-option value="" *ngIf="tallerForm.sellerDesc?.length > 0 && tallerForm.sellerResp?.length > 0">
                                {{ tallerForm.sellerResp }}
                            </mat-option>

                        </mat-autocomplete>
                    </mat-form-field>
                </div>
                <div class="col-md-6">
                    <mat-label>Cliente: </mat-label>
                    <mat-form-field class="with100">
                        <input #cbxCustomerCBX
                        type="text"
                                placeholder="Selecciona..."
                                aria-label="Number"
                                matInput
                                [(ngModel)]="tallerForm.customerDesc"
                                [matAutocomplete]="cbxCustomer"
                                (keyup)="comboBoxKeyUp('cbxCustomerCBX', cbxCustomerCBX.value, $event)"
                                (click)="cbxCustomers_Clear()">
                                <button *ngIf="tallerForm.customerDesc" matSuffix mat-icon-button aria-label="Clear" (click)="cbxCustomers_Clear()">
                                    <mat-icon>close</mat-icon>
                                </button>
                        <mat-autocomplete autoActiveFirstOption
                                            #cbxCustomer="matAutocomplete"
                                            (optionSelected)="cbxCustomers_SelectedOption( $event )">
                            <mat-option *ngFor="let item of cbxCustomers" [value]="item">
                                {{ item.name }}
                            </mat-option>

                            <mat-option value="" *ngIf="tallerForm.customerResp?.length > 0 && tallerForm.customerResp?.length > 0">
                                {{ tallerForm.customerResp }}
                            </mat-option>

                        </mat-autocomplete>
                    </mat-form-field>
                </div>
            </div>

            <!-- Descripción -->
            <div class="row top15px">
                <div class="col-md-12">
                    <mat-form-field class="with100">
                        <mat-label>Descripción</mat-label>
                        <textarea matInput
                        #descripcionInput
                        [(ngModel)]="tallerForm.descripcion"
                        placeholder="Ingrese la descripción del taller"
                        rows="4"></textarea>
                    </mat-form-field>
                </div>
            </div>

            <!-- Fechas -->
            <div class="row top15px">
                <div class="col-md-4">
                    <mat-form-field class="with100">
                        <mat-label>Fecha de Ingreso</mat-label>
                        <input matInput
                        [matDatepicker]="pickerIngreso"
                        [(ngModel)]="tallerForm.fechaIngreso"
                        readonly>
                        <mat-datepicker-toggle matIconSuffix [for]="pickerIngreso"></mat-datepicker-toggle>
                        <mat-datepicker #pickerIngreso></mat-datepicker>
                    </mat-form-field>
                </div>

                <div class="col-md-4">
                    <mat-form-field class="with100">
                        <mat-label>Fecha Prometida de Entrega</mat-label>
                        <input matInput
                        [matDatepicker]="pickerPromesa"
                        [(ngModel)]="tallerForm.fechaPrometidaEntrega"
                        placeholder="Seleccione fecha">
                        <mat-datepicker-toggle matIconSuffix [for]="pickerPromesa"></mat-datepicker-toggle>
                        <mat-datepicker #pickerPromesa></mat-datepicker>
                    </mat-form-field>
                </div>

                <div class="col-md-4">
                    <mat-form-field class="with100">
                        <mat-label>Fecha Entregada</mat-label>
                        <input matInput
                        [(ngModel)]="tallerForm.fechaEntrega"
                        readonly
                        placeholder="Se llena automáticamente">
                    </mat-form-field>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="row top30px">
                <div class="col-md-12" style="text-align: right;">

                    <button mat-raised-button
                    color="primary"
                    type="submit"
                    class="marginRight10px top10px"
                    (click)="fn_ShowPayments()">
                    Pagar</button>

                    <button *ngIf="tallerForm.idTaller > 0"
                    mat-raised-button
                    color="accent"
                    type="button"
                    class="marginRight10px"
                    (click)="openTallerHeaderImagesDialog()">
                    <mat-icon matPrefix class="my-icon">image</mat-icon>
                    Cargar Imágenes ({{ tallerForm.headerImagesCount }})</button>

                    <button *ngIf="tallerForm.idTaller > 0 && tallerForm.idTallerStatus === 1"
                    mat-raised-button
                    color="warn"
                    type="button"
                    class="marginRight10px"
                    (click)="fn_createTallerOrder()">
                    <mat-icon matPrefix class="my-icon">playlist_add</mat-icon>
                    Crear pedido de taller</button>

                    <button *ngIf="tallerForm.idTaller > 0 && tallerForm.idTallerStatus === 2"
                    mat-raised-button
                    color="accent"
                    type="button"
                    class="marginRight10px"
                    (click)="fn_assignTallerOrder()">
                    <mat-icon matPrefix class="my-icon">assignment</mat-icon>
                    Asignar</button>

                    <button *ngIf="tallerForm.idTaller > 0 && tallerForm.idTallerStatus === 3"
                    mat-raised-button
                    color="primary"
                    type="button"
                    class="marginRight10px"
                    (click)="fn_finalizeTallerOrder()">
                    <mat-icon matPrefix class="my-icon">done_all</mat-icon>
                    Finalizado/Mostrador</button>

                    <button *ngIf="tallerForm.idTaller > 0 && tallerForm.idTallerStatus === 4"
                    mat-raised-button
                    color="success"
                    type="button"
                    class="marginRight10px"
                    (click)="fn_deliverTallerOrder()">
                    <mat-icon matPrefix class="my-icon">check_circle</mat-icon>
                    Entregado</button>

                    <button *ngIf="tallerForm.idTallerStatus === 1 || tallerForm.idTaller === 0"
                    mat-raised-button
                    color="primary"
                    type="button"
                    class="marginRight10px"
                    (click)="fn_saveTaller()">
                    <mat-icon matPrefix class="my-icon">save</mat-icon>
                    {{ tallerForm.idTaller == 0 ? 'Generar folio' : 'Actualizar encabezado' }}</button>
                </div>
            </div>

            <div *ngIf="tallerForm.idTaller > 0">

              <!-- SECCIÓN DE REFACCIONES -->
              <div class="card-refacciones top30px">
                  <div class="header-refacciones">
                      <h3>Refacciones <span class="total-refacciones">Total: {{ totalRefacciones | currency }}</span></h3>
                  </div>

                  <div class="body-refacciones">
                      <!-- RadioButton de tipo -->
                      <div class="row">
                          <div class="col-md-12">
                              <mat-radio-group [(ngModel)]="refaccionTipo" (change)="fn_changeRefaccionTipo(refaccionTipo)" class="radio-group">
                                  <mat-radio-button value="producto" class="radio-option">
                                      <mat-icon>inventory</mat-icon> Producto
                                  </mat-radio-button>
                                  <mat-radio-button value="porDefinir" class="radio-option">
                                      <mat-icon>description</mat-icon> Por Definir
                                  </mat-radio-button>
                              </mat-radio-group>
                          </div>
                      </div>

                      <!-- FORMULARIO PRODUCTO -->
                      <div *ngIf="refaccionTipo === 'producto'" class="form-producto top15px">
                          <div class="row">
                              <div class="col-md-8">
                                  <mat-form-field
                                  style="width: 100%;"
                                  (click)="cbxProducts_Search()">
                                      <input #cbxProductss
                                              type="text"
                                              id="cbxProduct"
                                              style="width: 100%;"
                                              placeholder="Selecciona un producto..."
                                              aria-label="Number"
                                              matInput
                                              [(ngModel)]="refaccionForm.productDesc"
                                              [matAutocomplete]="cbxProduct"
                                              (keyup)="comboBoxKeyUp('cbxProduct', cbxServiciosExternosCBX.value, $event)"
                                              (click)="cbxProducts_Clear()">
                                              <button *ngIf="refaccionForm.productDesc" matSuffix mat-icon-button aria-label="Clear" (click)="cbxProducts_Clear()">
                                                  <mat-icon>close</mat-icon>
                                              </button>
                                      <mat-autocomplete autoActiveFirstOption
                                                          #cbxProduct="matAutocomplete"
                                                          (optionSelected)="cbxProducts_SelectedOption( $event )">
                                          <mat-option *ngFor="let item of cbxProducts" [value]="item">
                                              <mat-icon matPrefix class="my-icon">qr_code</mat-icon>{{ item.nameConcat }}
                                          </mat-option>

                                          <mat-option value="" *ngIf="cbxProducts.length == 0 && refaccionForm.productDesc">
                                              No se encontró nada...
                                          </mat-option>

                                      </mat-autocomplete>
                                  </mat-form-field>
                              </div>
                              <div class="col-md-4">
                                  <mat-form-field class="with100">
                                      <mat-label>Cantidad</mat-label>
                                      <input #refaccionCantidadInput
                                      matInput type="number" [(ngModel)]="refaccionForm.cantidad" min="0" placeholder="0"
                                      (keyup.enter)="fn_agregarRefaccion()">
                                  </mat-form-field>
                              </div>
                          </div>
                      </div>

                      <!-- FORMULARIO POR DEFINIR -->
                      <div *ngIf="refaccionTipo === 'porDefinir'" class="form-por-definir top15px">
                          <div class="row">
                              <div class="col-md-12">
                                  <mat-form-field class="with100">
                                      <mat-label>Descripción</mat-label>
                                      <input #refaccionPorDefinirDescInput matInput [(ngModel)]="refaccionForm.productDesc" placeholder="Descripción del artículo"
                                      (keyup.enter)="fn_focusNextRefaccion('cantidad')">
                                  </mat-form-field>
                              </div>
                          </div>
                          <div class="row top10px">
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Cantidad</mat-label>
                                      <input #refaccionPorDefinirCantidadInput matInput type="number" [(ngModel)]="refaccionForm.cantidad" min="0" placeholder="0"
                                      (keyup.enter)="fn_focusNextRefaccion('costo')">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Costo</mat-label>
                                      <input #refaccionPorDefinirCostoInput matInput type="number" [(ngModel)]="refaccionForm.costo" min="0" placeholder="0"
                                      (keyup.enter)="fn_focusNextRefaccion('precio')">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Precio</mat-label>
                                      <input #refaccionPorDefinirPrecioInput matInput type="number" [(ngModel)]="refaccionForm.precio" min="0" placeholder="0"
                                      (keyup.enter)="fn_agregarRefaccion()">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <div class="total-display">
                                      <strong>Total:</strong> {{ (refaccionForm.cantidad * refaccionForm.precio) | currency }}
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- BOTÓN AGREGAR -->
                      <div class="row top15px">
                          <div class="col-md-12">
                              <button mat-raised-button color="accent" (click)="fn_agregarRefaccion()" class="btn-agregar">
                                  <mat-icon>add</mat-icon>{{ ( refaccionForm.idRefaccion > 0 ? 'Editar' : 'Agregar' ) }} Refacción
                              </button>
                          </div>
                      </div>

                      <!-- TABLA DE REFACCIONES -->
                      <div *ngIf="refaccionesList.length > 0" class="table-refacciones top20px">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr class="header-table">
                                          <th class="col-acciones">Acciones</th>
                                          <th class="col-descripcion">Descripción</th>
                                          <th class="col-cantidad">Cantidad</th>
                                          <th class="col-precio">Precio Unit.</th>
                                          <th class="col-total">Total</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <tr *ngFor="let item of refaccionesList" class="row-refaccion">
                                          <td class="col-acciones text-center">
                                            <button *ngIf="item.idProduct === 0" mat-icon-button (click)="fn_changeProductoFromPorDefinir(item)" matTooltip="Cambiar a Producto">
                                                <mat-icon class="colorBlue">sync_alt</mat-icon>
                                            </button>
                                            <button mat-icon-button (click)="editRefaccionGrid(item)" matTooltip="Editar Refacción">
                                                <mat-icon class="colorGreen">edit</mat-icon>
                                            </button>
                                            <button mat-icon-button (click)="fn_eliminarRefaccion(item.idRefaccion)" matTooltip="Eliminar">
                                                <mat-icon class="icon-delete">delete_outline</mat-icon>
                                            </button>
                                          </td>
                                          <td class="col-descripcion">
                                              <mat-icon *ngIf="item.tipo === 'producto'" class="icon-tipo" matTooltip="Producto">inventory</mat-icon>
                                              <mat-icon *ngIf="item.tipo === 'porDefinir'" class="icon-tipo" matTooltip="Por Definir">description</mat-icon>
                                              {{ item.productDesc }}
                                          </td>
                                          <td class="col-cantidad text-center">{{ item.cantidad | number:'1.0-0' }}</td>
                                          <td class="col-precio text-right">{{ item.precio | currency }}</td>
                                          <td class="col-total text-right"><strong>{{ item.total | currency }}</strong></td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>

                      <!-- MENSAJE VACÍO -->
                      <div *ngIf="refaccionesList.length === 0" class="empty-state top20px">
                          <mat-icon>folder_open</mat-icon>
                          <p>No hay refacciones agregadas</p>
                      </div>
                  </div>
              </div>

              <!-- SECCIÓN SERVICIOS EXTERNOS -->
              <div class="card-refacciones top30px">
                  <div class="header-refacciones">
                      <h3>Servicios Externos <span class="total-servicios">Total: {{ totalServiciosExternos | currency }}</span></h3>
                      <button mat-icon-button (click)="abrirModalServiciosExternos()" matTooltip="Gestionar Servicios Externos">
                          <mat-icon>settings</mat-icon>
                      </button>
                  </div>

                  <div class="body-refacciones">
                      <!-- FORMULARIO SERVICIOS EXTERNOS -->
                      <div class="form-servicios top15px">
                          <div class="row">
                              <div class="col-md-5">
                                <mat-form-field appearance="outline" style="width: 100%;" (click)="cbxServiciosExternos_Clear(); cbxServiciosExternos_Search()">
                                  <mat-label>Servicio Externo</mat-label>
                                  <input #cbxServiciosExternosCBX matInput [(ngModel)]="servicioExternoForm.servicioExternoDesc"
                                        id="cbxServiciosExternosMdl"
                                        [matAutocomplete]="_cbxServiciosExternos"
                                        (keyup)="comboBoxKeyUp('cbxServiciosExternos', cbxServiciosExternosCBX.value, $event)"
                                        (click)="cbxServiciosExternos_Clear()" placeholder="Selecciona...">
                                  <button *ngIf="servicioExternoForm.servicioExternoDesc" matSuffix mat-icon-button aria-label="Clear" (click)="cbxServiciosExternos_Clear()">
                                    <mat-icon>close</mat-icon>
                                  </button>
                                  <mat-autocomplete autoActiveFirstOption #_cbxServiciosExternos="matAutocomplete" (optionSelected)="cbxServiciosExternos_SelectedOption($event)">
                                    <mat-option *ngFor="let role of cbxServiciosExternos" [value]="role">{{ role.name }}</mat-option>
                                    <mat-option value="" *ngIf="cbxServiciosExternos.length == 0 && servicioExternoForm.servicioExternoDesc">No se encontró nada...</mat-option>
                                  </mat-autocomplete>
                                </mat-form-field>
                              </div>
                              <div class="col-md-1">
                                  <button mat-icon-button color="accent" (click)="abrirModalServiciosExternos()"
                                      matTooltip="Gestionar Servicios Externos">
                                      <mat-icon>settings</mat-icon>
                                  </button>
                              </div>
                              <div class="col-md-2">
                                  <mat-form-field class="with100">
                                      <mat-label>Cantidad</mat-label>
                                      <input #servicioExternoCantidadInput
                                      matInput type="number" [(ngModel)]="servicioExternoForm.cantidad" min="1" placeholder="0"
                                      (keyup.enter)="fn_focusServicioExternoCosto()">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                  <mat-form-field class="with100">
                                      <mat-label>Costo</mat-label>
                                      <input #servicioExternoCostoInput
                                      matInput type="number" [(ngModel)]="servicioExternoForm.costo" min="0" placeholder="0"
                                      (keyup.enter)="fn_focusServicioExternoPrecio()">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                  <mat-form-field class="with100">
                                      <mat-label>Precio</mat-label>
                                      <input #servicioExternoPrecioInput
                                      matInput type="number" [(ngModel)]="servicioExternoForm.precio" min="0" placeholder="0"
                                      (keyup.enter)="fn_agregarServicioExterno()">
                                  </mat-form-field>
                              </div>
                          </div>
                      </div>

                      <!-- BOTÓN AGREGAR -->
                      <div class="row top15px">
                          <div class="col-md-12">
                              <button mat-raised-button color="accent" (click)="fn_agregarServicioExterno()" class="btn-agregar">
                                  <mat-icon>add</mat-icon>{{ ( servicioExternoForm.idServicioExternoDetalle > 0 ? 'Editar' : 'Agregar' ) }} Servicio Externo
                              </button>
                          </div>
                      </div>

                      <!-- TABLA DE SERVICIOS EXTERNOS -->
                      <div *ngIf="serviciosExternosList.length > 0" class="table-refacciones top20px">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr class="header-table">
                                          <th class="col-acciones">Acciones</th>
                                          <th class="col-descripcion">Servicios Externos</th>
                                          <th class="col-cantidad">Cantidad</th>
                                          <th class="col-precio">Precio Unit.</th>
                                          <th class="col-total">Total</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <tr *ngFor="let item of serviciosExternosList" class="row-refaccion">
                                          <td class="col-acciones text-center">
                                            <button mat-icon-button (click)="editServicioExternoGrid(item)" matTooltip="Editar Refacción">
                                                <mat-icon class="colorGreen">edit</mat-icon>
                                            </button>
                                              <button mat-icon-button (click)="fn_eliminarServicioExterno(item)" matTooltip="Eliminar">
                                                  <mat-icon class="icon-delete">delete_outline</mat-icon>
                                              </button>
                                          </td>
                                          <td class="col-descripcion">{{ item.servicioExtName }}</td>
                                          <td class="col-cantidad text-center">{{ item.cantidad | number:'1.0-0' }}</td>
                                          <td class="col-precio text-right">{{ item.precio | currency }}</td>
                                          <td class="col-total text-right"><strong>{{ item.total | currency }}</strong></td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>

                      <!-- MENSAJE VACÍO -->
                      <div *ngIf="serviciosExternosList.length === 0" class="empty-state top20px">
                          <mat-icon>folder_open</mat-icon>
                          <p>No hay servicios externos agregados</p>
                      </div>
                  </div>
              </div>

              <!-- SECCIÓN METAL AGRANEL -->
              <div class="card-refacciones top30px">
                  <div class="header-refacciones">
                      <h3>Metal Agranel <span class="total-metal">Total: {{ totalMetalAgranel | currency }}</span></h3>
                  </div>

                  <div class="body-refacciones">
                      <!-- RadioButton de tipo -->
                      <div class="row">
                          <div class="col-md-12">
                              <mat-label>Tipo de Metal:</mat-label>
                              <mat-radio-group [(ngModel)]="metalTipo" (change)="fn_changeMetalTipo(metalTipo)" class="radio-group">
                                  <mat-radio-button [value]="'oro'" class="radio-option">
                                      <mat-icon class="icon-oro" style="color: gold; margin-right: 5px;">circle</mat-icon>
                                      Oro
                                  </mat-radio-button>
                                  <mat-radio-button [value]="'plata'" class="radio-option">
                                      <mat-icon class="icon-plata" style="color: silver; margin-right: 5px;">circle</mat-icon>
                                      Plata
                                  </mat-radio-button>
                              </mat-radio-group>
                          </div>
                      </div>

                      <!-- FORMULARIO METAL AGRANEL -->
                      <div class="form-metal top15px">
                          <div class="row">
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Gramos</mat-label>
                                      <input #metalAgranelGramosInput
                                        matInput
                                        type="number"
                                        [(ngModel)]="metalAgranelForm.gramos"
                                        (blur)="fn_calculateMetalValue()"
                                        (keyup.enter)="fn_focusMetalAgranelKilates()"
                                        min="0"
                                        placeholder="0">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Kilataje</mat-label>
                                      <mat-select #metalAgranelKilatesSelect #metalAgranelKilatesSelectRef
                                      [(ngModel)]="metalAgranelForm.kilates"
                                      (selectionChange)="fn_onMetalAgranelKilatesChange()">
                                          <mat-option *ngFor="let kilate of kilatajes" [value]="kilate">
                                              {{ kilate }} Kilates
                                          </mat-option>
                                      </mat-select>
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Valor del Metal</mat-label>
                                      <input #metalAgranelValorMetalInput
                                      matInput type="number" [(ngModel)]="metalAgranelForm.valorMetal" min="0" placeholder="0.00"
                                      (keyup.enter)="fn_agregarMetalAgranel()">
                                  </mat-form-field>
                              </div>
                          </div>
                      </div>

                      <!-- BOTÓN AGREGAR -->
                      <div class="row top15px">
                          <div class="col-md-12">
                              <button mat-raised-button color="accent" (click)="fn_agregarMetalAgranel()" class="btn-agregar">
                                  <mat-icon>add</mat-icon>{{ metalAgranelForm.idMetalAgranel > 0 ? 'Actualizar' : 'Agregar' }} Metal
                              </button>
                          </div>
                      </div>

                      <!-- TABLA DE METAL AGRANEL -->
                      <div *ngIf="metalAgranelList.length > 0" class="table-refacciones top20px">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr class="header-table">
                                          <th class="col-acciones">Acciones</th>
                                          <th class="col-tipo">Tipo</th>
                                          <th class="col-gramos">Gramos</th>
                                          <th class="col-kilates">Kilataje</th>
                                          <th class="col-valor">Valor Metal</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <tr *ngFor="let item of metalAgranelList" class="row-metal">
                                          <td class="col-acciones text-center">
                                              <button mat-icon-button (click)="editMetalAgranelGrid(item)" matTooltip="Editar Metal">
                                                  <mat-icon class="colorGreen">edit</mat-icon>
                                              </button>
                                              <button mat-icon-button (click)="fn_eliminarMetalAgranel(item.idMetalAgranel)" matTooltip="Eliminar">
                                                  <mat-icon class="icon-delete">delete_outline</mat-icon>
                                              </button>
                                          </td>
                                          <td class="col-tipo">
                                              <mat-icon [style.color]="item.tipo === 'oro' ? 'gold' : 'silver'">circle</mat-icon>
                                              {{ item.tipo | uppercase }}
                                          </td>
                                          <td class="col-gramos text-center">{{ item.gramos | number:'1.0-0' }}</td>
                                          <td class="col-kilates text-center">{{ item.kilates | number:'1.0-0' }} K</td>
                                          <td class="col-valor text-right">{{ item.valorMetal | currency }}</td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>

                      <!-- MENSAJE VACÍO -->
                      <div *ngIf="metalAgranelList.length === 0" class="empty-state top20px">
                          <mat-icon>folder_open</mat-icon>
                          <p>No hay metales agregados</p>
                      </div>
                  </div>
              </div>

              <!-- SECCIÓN METAL DEL CLIENTE -->
              <div class="card-refacciones top30px">
                  <div class="header-refacciones">
                      <h3>Activo del Cliente <span class="total-activo">Total: {{ totalMetalCliente | currency }}</span></h3>
                  </div>

                  <div class="body-refacciones">
                      <!-- RadioButton de tipo -->
                      <div class="row">
                          <div class="col-md-12">
                              <mat-label>Tipo de Metal:</mat-label>
                              <mat-radio-group [(ngModel)]="metalClienteTipo" (change)="fn_changeMetalClienteTipo(metalClienteTipo)" class="radio-group">
                                  <mat-radio-button [value]="'oro'" class="radio-option">
                                      <mat-icon class="icon-oro" style="color: gold; margin-right: 5px;">circle</mat-icon>
                                      Oro
                                  </mat-radio-button>
                                  <mat-radio-button [value]="'plata'" class="radio-option">
                                      <mat-icon class="icon-plata" style="color: silver; margin-right: 5px;">circle</mat-icon>
                                      Plata
                                  </mat-radio-button>
                              </mat-radio-group>
                          </div>
                      </div>

                      <!-- FORMULARIO METAL CLIENTE -->
                      <div class="form-metal top15px">
                          <div class="row">
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Gramos</mat-label>
                                      <input #metalClienteGramosInput
                                        matInput
                                        type="number"
                                        [(ngModel)]="metalClienteForm.gramos"
                                        (blur)="fn_calculateMetalClienteValue()"
                                        (keyup.enter)="fn_focusMetalClienteKilates()"
                                        min="0"
                                        placeholder="0">
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Kilataje</mat-label>
                                      <mat-select #metalClienteKilatesSelect #metalClienteKilatesSelectRef
                                      [(ngModel)]="metalClienteForm.kilates"
                                      (selectionChange)="fn_onMetalClienteKilatesChange()">
                                          <mat-option *ngFor="let kilate of kilatajes_cliente" [value]="kilate">
                                              {{ kilate }} Kilates
                                          </mat-option>
                                      </mat-select>
                                  </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                  <mat-form-field class="with100">
                                      <mat-label>Valor del Metal</mat-label>
                                      <input #metalClienteValorMetalInput
                                      matInput type="number" [(ngModel)]="metalClienteForm.valorMetal" min="0" placeholder="0.00"
                                      (keyup.enter)="fn_agregarMetalCliente()">
                                  </mat-form-field>
                              </div>
                          </div>
                      </div>

                      <!-- BOTÓN AGREGAR -->
                      <div class="row top15px">
                          <div class="col-md-12">
                              <button mat-raised-button color="accent" (click)="fn_agregarMetalCliente()" class="btn-agregar">
                                  <mat-icon>add</mat-icon>{{ metalClienteForm.idMetalCliente > 0 ? 'Actualizar' : 'Agregar' }} Metal
                              </button>
                          </div>
                      </div>

                      <!-- TABLA DE METAL CLIENTE -->
                      <div *ngIf="metalClienteList.length > 0" class="table-refacciones top20px">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr class="header-table">
                                          <th class="col-acciones">Acciones</th>
                                          <th class="col-tipo">Tipo</th>
                                          <th class="col-gramos">Gramos</th>
                                          <th class="col-kilates">Kilataje</th>
                                          <th class="col-valor">Valor Metal</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <tr *ngFor="let item of metalClienteList" class="row-metal">
                                          <td class="col-acciones text-center">
                                              <button mat-icon-button (click)="editMetalClienteGrid(item)" matTooltip="Editar Metal">
                                                  <mat-icon class="colorGreen">edit</mat-icon>
                                              </button>
                                              <button mat-icon-button
                                                      (click)="openMetalClienteImagesDialog(item)"
                                                      matTooltip="Ver Fotos"
                                                      [matBadge]="item.imageCount || 0"
                                                      matBadgeColor="accent"
                                                      matBadgeSize="medium"
                                                      [matBadgeHidden]="(item.imageCount || 0) === 0">
                                                  <mat-icon class="colorBlue">image</mat-icon>
                                              </button>
                                              <button mat-icon-button (click)="fn_eliminarMetalCliente(item.idMetalCliente)" matTooltip="Eliminar">
                                                  <mat-icon class="icon-delete">delete_outline</mat-icon>
                                              </button>
                                          </td>
                                          <td class="col-tipo">
                                              <mat-icon [style.color]="item.tipo === 'oro' ? 'gold' : 'silver'">circle</mat-icon>
                                              {{ item.tipo | uppercase }}
                                          </td>
                                          <td class="col-gramos text-center">{{ item.gramos | number:'1.0-0' }}</td>
                                          <td class="col-kilates text-center">{{ item.kilates | number:'1.0-0' }} K</td>
                                          <td class="col-valor text-right">{{ item.valorMetal | currency }}</td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>

                      <!-- MENSAJE VACÍO -->
                      <div *ngIf="metalClienteList.length === 0" class="empty-state top20px">
                          <mat-icon>folder_open</mat-icon>
                          <p>No hay metales agregados</p>
                      </div>
                  </div>
              </div>

              <!-- SECCIÓN MANO DE OBRA -->
              <div class="card-refacciones top30px">
                  <div class="header-refacciones">
                      <h3>Mano de Obra <span class="total-manoobra">Total: {{ totalManoObra | currency }}</span></h3>
                  </div>

                  <div class="body-refacciones">
                      <!-- INPUT PRECIO MANO DE OBRA -->
                      <div class="row top15px">
                          <div class="col-md-12">
                              <mat-form-field class="with100">
                                  <mat-label>Precio Mano de Obra</mat-label>
                                  <input #manoObraPrecioInput
                                  matInput type="number" [(ngModel)]="tallerForm.manoObraPrecio" min="0" placeholder="0.00"
                                  (keyup.enter)="fn_saveManoObraPrecio()"
                                  (blur)="fn_saveManoObraPrecio()">
                              </mat-form-field>
                          </div>
                      </div>

                      <!-- FORMULARIO MANO DE OBRA -->
                      <div class="form-mano-obra top15px">
                          <div class="row">
                              <div class="col-md-8">
                                <mat-form-field appearance="outline" style="width: 100%;" (click)="cbxTecnicos_Clear(); cbxTecnicos_Search()">
                                  <mat-label>Técnico</mat-label>
                                  <input #cbxTecnicosCBX matInput [(ngModel)]="manoObraForm.tecnicoDesc"
                                        id="cbxTecnicosMdl"
                                        [matAutocomplete]="_cbxTecnicos"
                                        (keyup)="comboBoxKeyUp('cbxTecnicos', cbxTecnicosCBX.value, $event)"
                                        (click)="cbxTecnicos_Clear()" placeholder="Selecciona...">
                                  <button *ngIf="manoObraForm.tecnicoDesc" matSuffix mat-icon-button aria-label="Clear" (click)="cbxTecnicos_Clear()">
                                    <mat-icon>close</mat-icon>
                                  </button>
                                  <mat-autocomplete autoActiveFirstOption #_cbxTecnicos="matAutocomplete" (optionSelected)="cbxTecnicos_SelectedOption($event)">
                                    <mat-option *ngFor="let tecnico of cbxTecnicos" [value]="tecnico">{{ tecnico.nombre }}</mat-option>
                                    <mat-option value="" *ngIf="cbxTecnicos.length == 0 && manoObraForm.tecnicoDesc">No se encontró nada...</mat-option>
                                  </mat-autocomplete>
                                </mat-form-field>
                              </div>
                              <div class="col-md-4">
                                  <mat-form-field class="with100">
                                      <mat-label>Precio</mat-label>
                                      <input #manoObraCantidadInput
                                      matInput type="number" [(ngModel)]="manoObraForm.precio" min="0" placeholder="0"
                                      (keyup.enter)="fn_agregarManoObra()">
                                  </mat-form-field>
                              </div>
                          </div>
                      </div>

                      <!-- BOTÓN AGREGAR -->
                      <div class="row top15px">
                          <div class="col-md-12">
                              <button mat-raised-button color="accent" (click)="fn_agregarManoObra()" class="btn-agregar">
                                  <mat-icon>add</mat-icon>{{ ( manoObraForm.idManoObra > 0 ? 'Editar' : 'Agregar' ) }} Mano de Obra
                              </button>
                          </div>
                      </div>

                      <!-- TABLA DE MANO DE OBRA -->
                      <div *ngIf="manoObraList.length > 0" class="table-refacciones top20px">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr class="header-table">
                                          <th class="col-acciones">Acciones</th>
                                          <th class="col-descripcion">Técnico</th>
                                          <th class="col-precio">Precio</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <tr *ngFor="let item of manoObraList" class="row-refaccion">
                                          <td class="col-acciones text-center">
                                            <button mat-icon-button (click)="editManoObraGrid(item)" matTooltip="Editar Mano de Obra">
                                                <mat-icon class="colorGreen">edit</mat-icon>
                                            </button>
                                            <button mat-icon-button (click)="fn_eliminarManoObra(item)" matTooltip="Eliminar">
                                                <mat-icon class="icon-delete">delete_outline</mat-icon>
                                            </button>
                                          </td>
                                          <td class="col-descripcion">{{ item.tecnicoDesc }}</td>
                                          <td class="col-precio text-right"><strong>{{ item.precio | currency }}</strong></td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>

                      <!-- MENSAJE VACÍO -->
                      <div *ngIf="manoObraList.length === 0" class="empty-state top20px">
                          <mat-icon>folder_open</mat-icon>
                          <p>No hay mano de obra agregada</p>
                      </div>
                  </div>
              </div>

              <!-- Botones de Acción -->
              <div class="row top30px">
                  <div class="col-md-12" style="text-align: right;">
                      <button mat-raised-button
                      type="button"
                      (click)="fn_cancel()">
                      <mat-icon matPrefix class="my-icon">close</mat-icon>
                      Cancelar</button>
                  </div>
              </div>

            </div>


        </div>
    </div>
</div>

<app-spinner [hidden]="!bShowSpinner"></app-spinner>
